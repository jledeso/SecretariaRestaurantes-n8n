{
  "name": "Asistente Reservas Restaurante - AI Agent",
  "nodes": [
    {
      "parameters": {
        "content": "# üçΩÔ∏è Asistente de Reservas para Restaurantes\n\n## Workflow 100% n8n con AI Agent\n\n**Funcionalidades:**\n- ‚úÖ Consultar disponibilidad de mesas\n- ‚úÖ Crear reservas con datos de contacto\n- ‚úÖ Gestionar tronas y alzadores\n- ‚úÖ Cancelar/modificar reservas\n- ‚úÖ Notificaciones al personal\n\n**Requisitos:**\n- Supabase (tablas y funciones SQL)\n- OpenAI API Key\n- Telegram Bot (notificaciones)\n\n**Canales:**\n- n8n Web Chat integrado\n- WhatsApp Business\n- Telegram Bot",
        "height": 420,
        "width": 380,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [60, 60],
      "id": "sticky-intro",
      "name": "Introducci√≥n"
    },
    {
      "parameters": {
        "content": "## üì• Entrada: Chat Trigger\n\nRecibe mensajes del Web Chat integrado de n8n.\n\nPara WhatsApp/Telegram, crear workflows separados que env√≠en datos a este workflow.",
        "height": 180,
        "width": 280,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [60, 500],
      "id": "sticky-entrada",
      "name": "Nota Entrada"
    },
    {
      "parameters": {
        "content": "## ‚öôÔ∏è Configuraci√≥n\n\nLee la configuraci√≥n del restaurante desde Data Table.\n\n**Crear Data Table:**\n- Nombre: `config_restaurante`\n- Columnas: clave, valor, descripcion",
        "height": 200,
        "width": 280,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [360, 500],
      "id": "sticky-config",
      "name": "Nota Config"
    },
    {
      "parameters": {
        "content": "## ü§ñ AI Agent\n\nCerebro del asistente.\n\nConectados:\n- OpenAI Chat Model (gpt-4o-mini)\n- Simple Memory (sesiones)\n- 6 Tools (Supabase + Telegram)",
        "height": 200,
        "width": 280,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [660, 500],
      "id": "sticky-agent",
      "name": "Nota Agent"
    },
    {
      "parameters": {
        "content": "## üîß Herramientas (Tools)\n\nConectadas al AI Agent:\n\n1. **Verificar Disponibilidad** - Supabase\n2. **Crear Reserva** - Supabase\n3. **Consultar Sillas** - Supabase\n4. **Buscar Reserva** - Supabase\n5. **Cancelar Reserva** - Supabase\n6. **Notificar Personal** - Telegram",
        "height": 260,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [960, 500],
      "id": "sticky-tools",
      "name": "Nota Tools"
    },
    {
      "parameters": {
        "public": true,
        "mode": "hostedChat",
        "initialMessages": "¬°Hola! üëã Soy Marina, tu asistente de reservas de La Terraza Mediterr√°nea.\n\n¬øEn qu√© puedo ayudarte hoy?\n\n‚Ä¢ Hacer una reserva\n‚Ä¢ Consultar disponibilidad\n‚Ä¢ Cancelar o modificar reserva\n‚Ä¢ Informaci√≥n del restaurante",
        "options": {
          "title": "üçΩÔ∏è La Terraza Mediterr√°nea",
          "subtitle": "Asistente de reservas 24/7",
          "inputPlaceholder": "Escribe tu mensaje aqu√≠...",
          "responseMode": "lastNode",
          "showWelcomeScreen": false,
          "allowFileUploads": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [120, 260],
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "webhookId": "reservas-restaurante-chat"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "mode": "id",
          "value": "={{/* REEMPLAZAR CON ID DE TU DATA TABLE config_restaurante */}}"
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [380, 260],
      "id": "get-config",
      "name": "Obtener Configuraci√≥n"
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "chat-input",
              "name": "chatInput",
              "value": "={{ $('Chat Trigger').item.json.chatInput }}",
              "type": "string"
            },
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{ $('Chat Trigger').item.json.sessionId }}",
              "type": "string"
            },
            {
              "id": "config-obj",
              "name": "config",
              "value": "={{ Object.fromEntries($input.all().map(row => [row.json.clave, row.json.valor])) }}",
              "type": "object"
            },
            {
              "id": "fecha-actual",
              "name": "fecha_actual",
              "value": "={{ $now.format('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "hora-actual",
              "name": "hora_actual",
              "value": "={{ $now.format('HH:mm') }}",
              "type": "string"
            },
            {
              "id": "dia-semana",
              "name": "dia_semana",
              "value": "={{ ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'][$now.weekday] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [600, 260],
      "id": "preparar-contexto",
      "name": "Preparar Contexto"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "# ROL\nEres {{ $json.config.nombre_agente || 'Marina' }}, la asistente virtual de reservas de {{ $json.config.nombre_restaurante || 'La Terraza Mediterr√°nea' }}.\n\n# PERSONALIDAD\n- Amable, eficiente y servicial\n- Hablas de t√∫ a los clientes\n- Transmites la esencia mediterr√°nea y relajada del restaurante\n- Eres proactiva ofreciendo alternativas cuando no hay disponibilidad\n- Conoces perfectamente el restaurante, sus zonas y especialidades\n\n# INFORMACI√ìN DEL RESTAURANTE\n- **Nombre**: {{ $json.config.nombre_restaurante || 'La Terraza Mediterr√°nea' }}\n- **Direcci√≥n**: {{ $json.config.direccion || 'Paseo Mar√≠timo 45, Valencia' }}\n- **Tel√©fono**: {{ $json.config.telefono || '96 123 45 67' }}\n- **Horario comidas**: {{ $json.config.horario_comidas || '13:00 a 16:00' }}\n- **Horario cenas**: {{ $json.config.horario_cenas || '20:00 a 23:30' }}\n- **D√≠a de cierre**: {{ $json.config.dia_cierre || 'Lunes (excepto festivos)' }}\n- **Precio medio**: {{ $json.config.precio_medio || '35-45‚Ç¨ por persona' }}\n- **Men√∫ del d√≠a**: {{ $json.config.menu_dia_precio || '18,90‚Ç¨' }} (L-V comidas)\n\n# ZONAS DISPONIBLES\n1. **Terraza** - Exterior con vistas al mar, sombrillas\n2. **Sal√≥n Interior** - Ambiente climatizado y acogedor\n3. **Barra** - Mesas altas, ideal para aperitivos\n4. **Sal√≥n Privado** - Eventos privados (8-20 personas)\n5. **Terraza Superior** - Mejores vistas panor√°micas\n\n# SILLAS PARA NI√ëOS\n- Tronas disponibles: {{ $json.config.total_tronas || '6' }}\n- Alzadores disponibles: {{ $json.config.total_alzadores || '4' }}\n- M√°ximo por reserva: {{ $json.config.max_sillas_reserva || '3' }}\n\n# REGLAS DE RESERVA\n- Antelaci√≥n m√≠nima: {{ $json.config.anticipacion_minima || '2' }} horas\n- Antelaci√≥n m√°xima: {{ $json.config.anticipacion_maxima || '60' }} d√≠as\n- Duraci√≥n est√°ndar: {{ $json.config.duracion_reserva || '120' }} minutos\n- Tolerancia llegada: 15 minutos\n\n# FECHA Y HORA ACTUAL\n- Fecha: {{ $json.fecha_actual }}\n- Hora: {{ $json.hora_actual }}\n- D√≠a: {{ $json.dia_semana }}\n\n# FLUJO DE CONVERSACI√ìN\n\n## Para NUEVA RESERVA:\n1. Pregunta: ¬øPara cu√°ntas personas?\n2. Pregunta: ¬øQu√© d√≠a y a qu√© hora? (comida 13-16h o cena 20-23:30h)\n3. Pregunta: ¬øTienes preferencia de zona? (terraza, interior, privado...)\n4. Usa herramienta: verificar_disponibilidad_mesas\n5. Si hay disponibilidad:\n   - Muestra las opciones con zona, √°rea, capacidad y caracter√≠sticas\n   - Pide nombre completo y tel√©fono de contacto\n   - Pregunta si necesitan trona o alzador para ni√±os\n   - Confirma TODOS los datos antes de crear la reserva\n   - Usa herramienta: crear_reserva\n   - Proporciona el c√≥digo de reserva (RES-XXXXX)\n   - Recuerda: direcci√≥n y hora de llegada\n6. Si NO hay disponibilidad:\n   - Ofrece alternativas: otra hora del mismo d√≠a, otra zona\n   - Sugiere d√≠as cercanos con disponibilidad\n\n## Para CONSULTA DE DISPONIBILIDAD:\n1. Pregunta los datos necesarios (personas, fecha, hora)\n2. Usa herramienta: verificar_disponibilidad_mesas\n3. Informa las opciones disponibles con detalles\n4. Ofrece hacer la reserva directamente si le interesa\n\n## Para SILLAS DE NI√ëO:\n1. Pregunta para qu√© fecha necesita las sillas\n2. Usa herramienta: consultar_sillas_disponibles\n3. Informa la disponibilidad de tronas y alzadores\n4. Recuerda que se pueden reservar junto con la mesa (m√°x. 3 por reserva)\n\n## Para CANCELAR RESERVA:\n1. Pide el c√≥digo de reserva (RES-XXXXX) o el tel√©fono\n2. Usa herramienta: buscar_reserva\n3. Confirma los datos de la reserva encontrada\n4. Pregunta si est√° seguro de cancelar\n5. Usa herramienta: cancelar_reserva\n6. Confirma la cancelaci√≥n y ofrece reservar para otra ocasi√≥n\n\n## Para MODIFICAR RESERVA:\n1. Pide el c√≥digo de reserva o tel√©fono\n2. Usa herramienta: buscar_reserva\n3. Pregunta qu√© desea cambiar\n4. Si es fecha/hora: verificar nueva disponibilidad\n5. Actualizar la reserva\n\n## Para CONSULTAS GENERALES:\nResponde usando la informaci√≥n proporcionada sobre:\n- Horarios de apertura y cierre\n- Ubicaci√≥n y c√≥mo llegar\n- Carta, especialidades (paellas, arroces, pescado)\n- Men√∫ del d√≠a\n- Eventos privados y grupos\n- Formas de pago (efectivo, tarjeta, Bizum)\n- Parking cercano\n- Accesibilidad\n- Mascotas (permitidas en terraza)\n\n# FORMATO DE RESPUESTAS\n- S√© conciso pero informativo\n- Usa emojis con moderaci√≥n (üçΩÔ∏è üìÖ ‚úÖ)\n- Para listas de mesas, formatea claramente\n- Siempre confirma la informaci√≥n importante\n\n# AL FINALIZAR UNA RESERVA\n1. Proporciona el c√≥digo de confirmaci√≥n\n2. Resume: fecha, hora, personas, mesa, sillas ni√±o si aplica\n3. Recuerda: \"Te esperamos en {{ $json.config.nombre_restaurante || 'La Terraza Mediterr√°nea' }}, {{ $json.config.direccion || 'Paseo Mar√≠timo 45' }}\"\n4. Menciona la tolerancia de 15 minutos\n\n# SI NO SABES ALGO\nOfrece el tel√©fono {{ $json.config.telefono || '96 123 45 67' }} para consultas espec√≠ficas.",
          "maxIterations": 10,
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [860, 260],
      "id": "ai-agent",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [720, 480],
      "id": "openai-model",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Preparar Contexto').item.json.sessionId }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [860, 480],
      "id": "memory",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Verifica qu√© mesas est√°n disponibles para una fecha, hora y n√∫mero de personas espec√≠ficos. Opcionalmente filtra por zona (Terraza, Interior, Privado, etc.). Devuelve lista de mesas con ID, zona, √°rea, capacidad y caracter√≠sticas.",
        "operation": "getAll",
        "tableId": "mesas",
        "returnAll": true,
        "filterType": "string",
        "filterString": "activa=eq.true&capacidad=gte.{{ $fromAI('num_personas', 'N√∫mero de personas para la reserva', 'number') }}"
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [1000, 480],
      "id": "tool-disponibilidad",
      "name": "verificar_disponibilidad_mesas"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Crea una nueva reserva en el restaurante. Requiere: fecha (YYYY-MM-DD), hora (HH:MM), nombre_cliente, telefono, num_personas, mesa_id. Opcionales: email, tronas (n√∫mero), alzadores (n√∫mero), notas. Devuelve el c√≥digo de confirmaci√≥n.",
        "operation": "create",
        "tableId": "reservas",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "fecha",
              "fieldValue": "={{ $fromAI('fecha', 'Fecha de la reserva en formato YYYY-MM-DD', 'string') }}"
            },
            {
              "fieldId": "hora",
              "fieldValue": "={{ $fromAI('hora', 'Hora de la reserva en formato HH:MM', 'string') }}"
            },
            {
              "fieldId": "nombre_cliente",
              "fieldValue": "={{ $fromAI('nombre_cliente', 'Nombre completo del cliente', 'string') }}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{ $fromAI('telefono', 'Tel√©fono de contacto del cliente', 'string') }}"
            },
            {
              "fieldId": "num_personas",
              "fieldValue": "={{ $fromAI('num_personas', 'N√∫mero de comensales', 'number') }}"
            },
            {
              "fieldId": "mesa_id",
              "fieldValue": "={{ $fromAI('mesa_id', 'ID de la mesa seleccionada, ejemplo: M001', 'string') }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $fromAI('email', 'Email del cliente, dejar vac√≠o si no lo proporciona', 'string') }}"
            },
            {
              "fieldId": "tronas",
              "fieldValue": "={{ $fromAI('tronas', 'N√∫mero de tronas/sillas para beb√© necesarias, 0 si no necesita', 'number') }}"
            },
            {
              "fieldId": "alzadores",
              "fieldValue": "={{ $fromAI('alzadores', 'N√∫mero de alzadores para ni√±os necesarios, 0 si no necesita', 'number') }}"
            },
            {
              "fieldId": "notas",
              "fieldValue": "={{ $fromAI('notas', 'Notas especiales o peticiones del cliente', 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [1140, 480],
      "id": "tool-crear-reserva",
      "name": "crear_reserva"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Consulta la disponibilidad de tronas (sillas para beb√©) y alzadores (sillas elevadoras para ni√±os) para una fecha espec√≠fica. Devuelve cu√°ntas est√°n disponibles.",
        "operation": "getAll",
        "tableId": "reservas",
        "returnAll": true,
        "filterType": "string",
        "filterString": "fecha=eq.{{ $fromAI('fecha', 'Fecha a consultar en formato YYYY-MM-DD', 'string') }}&estado=in.(pendiente,confirmada)"
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [1280, 480],
      "id": "tool-sillas",
      "name": "consultar_sillas_disponibles"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Busca una reserva existente por c√≥digo de reserva (RES-XXXXX) o por tel√©fono del cliente. Devuelve todos los detalles de la reserva.",
        "operation": "getAll",
        "tableId": "reservas",
        "returnAll": false,
        "limit": 5,
        "filterType": "string",
        "filterString": "or=(codigo.eq.{{ $fromAI('codigo', 'C√≥digo de reserva RES-XXXXX o dejar vac√≠o', 'string') }},telefono.eq.{{ $fromAI('telefono', 'Tel√©fono del cliente o dejar vac√≠o', 'string') }})"
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [1000, 620],
      "id": "tool-buscar",
      "name": "buscar_reserva"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Cancela una reserva existente. Cambia el estado a 'cancelada'. Requiere el ID √∫nico (UUID) de la reserva, no el c√≥digo.",
        "operation": "update",
        "tableId": "reservas",
        "filterType": "string",
        "filterString": "id=eq.{{ $fromAI('reserva_id', 'UUID de la reserva a cancelar', 'string') }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "estado",
              "fieldValue": "cancelada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [1140, 620],
      "id": "tool-cancelar",
      "name": "cancelar_reserva"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Env√≠a una notificaci√≥n al personal del restaurante por Telegram. Usar para reservas de grupos grandes (8+ personas), peticiones especiales importantes, o situaciones que requieran atenci√≥n.",
        "chatId": "={{ $('Preparar Contexto').item.json.config.telegram_chat_id || '-1001234567890' }}",
        "text": "={{ $fromAI('mensaje', 'Mensaje para notificar al personal del restaurante', 'string') }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegramTool",
      "typeVersion": 1,
      "position": [1280, 620],
      "id": "tool-telegram",
      "name": "notificar_personal"
    }
  ],
  "pinData": {},
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "Obtener Configuraci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Configuraci√≥n": {
      "main": [
        [
          {
            "node": "Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "verificar_disponibilidad_mesas": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "crear_reserva": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_sillas_disponibles": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "buscar_reserva": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "cancelar_reserva": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "notificar_personal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Madrid",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "asistente-reservas-restaurante"
  },
  "id": "asistente-reservas-restaurante",
  "tags": [
    {
      "name": "AI Agent",
      "id": "ai-agent"
    },
    {
      "name": "Restaurante",
      "id": "restaurante"
    },
    {
      "name": "Reservas",
      "id": "reservas"
    },
    {
      "name": "Supabase",
      "id": "supabase"
    }
  ]
}
